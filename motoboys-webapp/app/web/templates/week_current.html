{% extends "base.html" %}
{% set nav="weeks" %}
{% set title="Semana" %}
{% block content %}
  <header class="pagehead">
    <h1>Semana</h1>
    <p class="muted">Resumo → fechar → pagar → exportar.</p>
  </header>

  <section class="card">
    <form method="get" action="/ui/weeks/current" class="form form--row">
      <label class="field field--inline">
        <span>Semana</span>
        <select name="week_id" onchange="this.form.submit()">
          {% for w in weeks %}
            <option value="{{ w.id }}" {% if w.id == week_id %}selected{% endif %}>
              {{ w.start_date }} → {{ w.end_date }} ({{ w.status }})
            </option>
          {% endfor %}
        </select>
      </label>

      <div class="pill">
        <span class="muted">Status</span>
        <strong class="mono">{{ week.status }}</strong>
      </div>

      <div class="pill mono">
        {{ week.start_date }} → {{ week.end_date }}
      </div>

      <div class="pill">
        <span class="muted">Pendências</span>
        <strong class="mono">{{ pending_total }}</strong>
      </div>
    </form>

    {% if pending_total > 0 %}
      <div class="flash flash--err">Existe(m) {{ pending_total }} pendência(s) aberta(s). Fechamento bloqueado.</div>
    {% endif %}

    <div class="actions">
      <form method="post" action="/ui/weeks/{{ week_id }}/close" data-confirm="Fechar a semana {{ week.start_date }} → {{ week.end_date }}? Isso cria o snapshot de pagamentos." data-loading="global">
        <button class="btn" type="submit"
          {% if role != 'ADMIN' or pending_total > 0 or week.status != 'OPEN' %}disabled{% endif %}
          title="{% if role != 'ADMIN' %}Somente ADMIN{% elif week.status != 'OPEN' %}Semana não está aberta{% elif pending_total>0 %}Resolva as pendências antes{% endif %}">
          Fechar semana
        </button>
      </form>

      <form method="post" action="/ui/weeks/{{ week_id }}/pay" data-confirm="Marcar como PAGA? (recomendado só após transferências/Pix feitos)" data-loading="global">
        <button class="btn btn--ghost" type="submit" {% if role != 'ADMIN' or week.status != 'CLOSED' %}disabled{% endif %} title="{% if role != 'ADMIN' %}Somente ADMIN{% else %}Feche a semana primeiro{% endif %}">
          Marcar como paga
        </button>
      </form>

      <a class="btn btn--ghost" href="/weeks/{{ week_id }}/payouts.csv">Exportar pagamentos (CSV)</a>
      <a class="btn btn--ghost" href="/weeks/{{ week_id }}/payouts_pix.csv">Exportar PIX (CSV)</a>
    </div>
  </section>

  <section class="card">
    <h2>Pagamentos (prévia)</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Entregador</th>
          <th class="num">Taxas</th>
          <th class="num">Extras</th>
          <th class="num">Vales</th>
          <th class="num">Parcelas</th>
          <th class="num">Líquido</th>
          <th class="num">Pendências</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr class="{% if r.is_flag_red %}row--red{% endif %}">
            <td>{{ r.courier_nome }}</td>
            <td class="num mono">{{ '%.2f'|format(r.rides_amount) }}</td>
            <td class="num mono">{{ '%.2f'|format(r.extras_amount) }}</td>
            <td class="num mono">{{ '%.2f'|format(r.vales_amount) }}</td>
            <td class="num mono">{{ '%.2f'|format(r.installments_amount) }}</td>
            <td class="num mono">
              {% if r.courier_id %}
                <a href="/ui/weeks/{{ week_id }}/couriers/{{ r.courier_id }}" class="mono"><strong>{{ '%.2f'|format(r.net_amount) }}</strong></a>
              {% else %}
                <strong>{{ '%.2f'|format(r.net_amount) }}</strong>
              {% endif %}
            </td>
            <td class="num mono">{{ r.pending_count }}</td>
            <td>
              {% if r.courier_id %}
                <a class="btn btn--small btn--ghost" href="/ui/weeks/{{ week_id }}/couriers/{{ r.courier_id }}">Auditar</a>
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        {% if not rows %}
          <tr><td colspan="8" class="muted">Sem dados para a semana.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <div class="muted" style="margin-top:10px">
      Clique no <strong>líquido</strong> (ou em <strong>Auditar</strong>) para ver rides + ledger que compõem o valor.
    </div>
  </section>
{% endblock %}
